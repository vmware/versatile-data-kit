# Copyright 2021-2023 VMware, Inc.
# SPDX-License-Identifier: Apache-2.0

.control_service_retry:
  retry_options:
    max: 1
    when:
      - always

.images:dind:
  image: docker:23.0.1
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  services:
    - docker:23.0.1-dind

# This grouping listens on changes to all code of control service
# Changes to this group should trigger runs of runs of unit and integration tests.
.control_service_code_changes: &control_service_code_change_locations
  - projects/control-service/cicd/**/*
  - projects/control-service/projects/base/**/*
  - projects/control-service/projects/model/**/*
  - projects/control-service/projects/pipelines_control_service/**/*
  - projects/control-service/projects/settings.gradle
  - projects/control-service/projects/versions-of-external-dependencies.gradle

# This grouping represents tracks changes in the helm chart
# Changes here should trigger actions like publishing images, new releases etc.
# but don't trigger unit or integration tests (without code changes)
.control_service_helm_changes: &control_service_helm_change_locations
  - projects/control-service/projects/helm_charts/pipelines-control-service/**/*

.control_service_base_build:
  image: docker:23.0.1
  variables:
    _JAVA_OPTIONS: "-Xms2048m -Xmx4096m"
  before_script:
    - apk --no-cache add openjdk17-jdk git zip curl zip py-pip
    - pip install --upgrade pip && pip install awscli

control_service_build_image:
  extends:
    - .control_service_base_build
    - .images:dind
  stage: build
  script:
    - apk --no-cache add git openjdk17-jdk
    - export TAG=$(git rev-parse --short HEAD)
    - cd projects/control-service/projects
    - ./gradlew -p ./model build publishToMavenLocal --info --stacktrace
    - ./gradlew build jacocoTestReport -x integrationTest --info --stacktrace
#    - ./gradlew :pipelines_control_service:docker --info --stacktrace -Pversion=$TAG
  retry: !reference [.control_service_retry, retry_options]
  coverage: "/    - Line Coverage: ([0-9.]+)%/"
  artifacts:
    when: always
    paths:
      - ./projects/control-service/projects/*/build/reports/**
    expire_in: 1 week
    reports:
      junit: ./projects/control-service/projects/**/build/test-results/test/TEST-*.xml
  only:
    refs:
      - external_pull_requests
    changes: *control_service_code_change_locations


control_service_publish_image:
  extends: .images:dind
  stage: publish_artifacts
  script:
    - apk add --no-cache git openjdk17-jdk
    - export TAG=$(git rev-parse --short HEAD)
    - docker login -u $VDK_DOCKER_REGISTRY_USERNAME -p $VDK_DOCKER_REGISTRY_PASSWORD
    - cd projects/control-service/projects
    - ./gradlew -p ./model build publishToMavenLocal --info --stacktrace
    - ./gradlew build -x test --info --stacktrace
    - ./gradlew :pipelines_control_service:dockerPush --info --stacktrace -Pversion=swaggertest
  retry: !reference [.control_service_retry, retry_options]
  artifacts:
    when: always
    reports:
      junit: ./projects/control-serviceprojects/**/build/test-results/test/TEST-*.xml
  only:
    refs:
      - external_pull_requests
    changes: *control_service_code_change_locations

